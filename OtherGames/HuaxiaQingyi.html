<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="google" content="notranslate" />
    <title>华夏论坛（严格版）</title>
    <style>
        /* 正常界面样式（封禁页将完全移除样式） */
        body.notranslate {
            -webkit-text-size-adjust: 100%;
        }

        body {
            margin: 0;
            background: #f5f6f7;
            font-family: Microsoft YaHei, "PingFang SC", sans-serif;
        }

        .header {
            background: #1f4e79;
            color: #fff;
            padding: 15px;
            font-size: 22px;
        }

        .container {
            width: 1000px;
            max-width: 96%;
            margin: 30px auto;
            background: #fff;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        input, textarea, select {
            width: 100%;
            padding: 8px;
            margin: 6px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            padding: 8px 14px;
            margin-top: 8px;
            background: #2d6ca2;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

            button:hover {
                background: #1f4e79;
            }

        .notice {
            background: #fff3cd;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .postItem {
            border-bottom: 1px solid #e6e6e6;
            padding: 12px;
            cursor: pointer;
        }

            .postItem:hover {
                background: #fafafa;
            }

        .postTitle {
            font-weight: 700;
            color: #333;
        }

        .postMeta {
            font-size: 12px;
            color: #777;
            margin-top: 6px;
        }

        .editorToolbar {
            margin: 6px 0;
        }

            .editorToolbar button {
                background: #eee;
                color: #000;
                border-radius: 3px;
                margin-right: 6px;
                padding: 6px;
            }

        .editor {
            min-height: 140px;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            background: #fff;
            overflow: auto;
        }

        .smallNote {
            font-size: 12px;
            color: #666;
            margin-top: 6px;
        }

        .error {
            color: #c0392b;
            margin-top: 6px;
        }

        .reply {
            margin-top: 10px;
            margin-left: 16px;
            padding-left: 10px;
            border-left: 3px solid #eee;
            background: #fafafa;
            border-radius: 4px;
            padding: 8px;
        }

        .quote {
            background: #fcfcfc;
            border-left: 3px solid #ddd;
            padding: 6px;
            margin: 6px 0;
        }

        .flexRow {
            display: flex;
            gap: 12px;
        }

        .half {
            flex: 1;
        }

        .bad-warning {
            color: #b21b1b;
            font-weight: 700;
            margin-top: 8px;
        }
    </style>
</head>
<body class="notranslate">
    <div id="app"></div>

    <script>
        /* ---------- 数据与配置 ---------- */
        let account = JSON.parse(localStorage.getItem("account")) || null;
        let forum = JSON.parse(localStorage.getItem("forum")) || [];
        let violations = parseInt(localStorage.getItem("violations")) || 0;
        let banned = localStorage.getItem("banned") === "true";
        let fakeIP = localStorage.getItem("fakeIP");
        if (!fakeIP) {
            fakeIP = "218." + Math.floor(Math.random() * 255) + "." + Math.floor(Math.random() * 255) + "." + Math.floor(Math.random() * 255);
            localStorage.setItem("fakeIP", fakeIP);
        }

        /* 验证词库 */
        const wordPool = [
            { en: "apple", cn: ["苹果", "蘋果"] },
            { en: "dog", cn: ["狗"] },
            { en: "car", cn: ["汽车", "汽車"] },
            { en: "water", cn: ["水"] },
            { en: "book", cn: ["书", "書"] },
            { en: "computer", cn: ["电脑", "電腦"] },
            { en: "sun", cn: ["太阳", "太陽"] }
        ];

        /* NPC 设置 */
        const npcNames = ["社会观察员", "城市评论", "热点关注", "理性之声", "时代见闻", "东方视角"];
        const npcTitles = ["关于社会发展的几点看法", "城市建设的未来方向", "大家怎么看最近的热点？", "如何提升生活质量？", "谈谈个人成长经历"];
        const npcReplies = ["请使用中文交流。", "请保持理性讨论。", "建议补充更多细节。", "这个话题值得深入研究。", "请遵守社区规则。"];

        /* 敏感词（中/英） */
        const badWords = ["傻", "滚", "垃圾", "废物", "操", "fuck", "shit", "bitch", "idiot", "asshole", "motherfucker"];

        /* 保存函数 */
        function saveAll() {
            localStorage.setItem("account", JSON.stringify(account));
            localStorage.setItem("forum", JSON.stringify(forum));
            localStorage.setItem("violations", String(violations));
            localStorage.setItem("banned", String(banned));
        }

        /* 敏感词检测（忽略大小写） */
        function containsBad(text) {
            if (!text) return false;
            const t = text.toLowerCase();
            return badWords.some(w => t.includes(w));
        }

        /* 判定是否非中文为主（中文字符占比 < 30%） */
        function isMostlyNonChinese(text) {
            if (!text) return false;
            const plain = stripTagsHtml(text);
            if (!plain) return false;
            const ch = (plain.match(/[\u4e00-\u9fa5]/g) || []).length;
            return ch < (plain.length * 0.3);
        }

        /* ---------- 注册（完整字段 + 验证词） ---------- */
        let currentWord = null;
        function showRegister() {
            currentWord = wordPool[Math.floor(Math.random() * wordPool.length)];
            document.getElementById("app").innerHTML = `
        <div class="header">华夏论坛 - 注册</div>
        <div class="container">
          <div class="flexRow">
            <div class="half">
              <label>名（First name）：</label>
              <input id="firstName" placeholder="名">
            </div>
            <div class="half">
              <label>姓（Last name）：</label>
              <input id="lastName" placeholder="姓">
            </div>
          </div>

          <label>用户名：</label>
          <input id="username" placeholder="用户名（作为登录名）">

          <label>密码：</label>
          <input type="password" id="password" placeholder="设置密码">

          <div class="flexRow">
            <div class="half">
              <label>出生日期：</label>
              <input type="date" id="dob">
            </div>
            <div class="half">
              <label>性别：</label>
              <select id="gender">
                <option value="">请选择</option>
                <option>男</option>
                <option>女</option>
                <option>其他</option>
              </select>
            </div>
          </div>

          <label>电子邮箱：</label>
          <input id="email" placeholder="example@domain.cn">

          <div class="smallNote">请将英文单词 <strong>${currentWord.en}</strong> 翻译为中文并填写（例如：${currentWord.cn.join(" / ")})</div>
          <input id="translate" placeholder="请输入翻译">

          <div id="regMsg" class="error"></div>
          <button onclick="attemptRegister()">提交注册</button>
        </div>
      `;
        }

        function attemptRegister() {
            const first = document.getElementById("firstName").value.trim();
            const last = document.getElementById("lastName").value.trim();
            const username = document.getElementById("username").value.trim();
            const password = document.getElementById("password").value.trim();
            const dob = document.getElementById("dob").value;
            const gender = document.getElementById("gender").value;
            const email = document.getElementById("email").value.trim();
            let translation = document.getElementById("translate").value.trim();

            const msgEl = document.getElementById("regMsg");
            msgEl.innerText = "";

            if (!first || !last || !username || !password || !dob || !gender || !email || !translation) {
                msgEl.innerText = "请完整填写所有注册信息。";
                return;
            }

            translation = translation.replace(/\s/g, "");
            const validList = (currentWord.cn || []).map(x => x.replace(/\s/g, ""));
            const ok = validList.some(v => v === translation);
            if (!ok) {
                msgEl.innerText = "验证失败：翻译不正确。系统将重新生成验证词，请重试。";
                setTimeout(showRegister, 900);
                return;
            }

            account = { first, last, username, dob, gender, email };
            saveAll();
            showForum();
        }

        /* ---------- 论坛首页（仅标题） ---------- */
        function showForum() {
            if (banned) { showBan(); return; }

            document.getElementById("app").innerHTML = `
        <div class="header">华夏论坛</div>
        <div class="container">
          <div class="notice">欢迎您：${escapeHtml(account.username)}</div>

          <label>帖子标题（必填）：</label>
          <input id="postTitle" placeholder="请填写标题">

          <div class="editorToolbar">
            <button onclick="format('bold')"><b>加粗</b></button>
            <button onclick="format('italic')"><i>斜体</i></button>
            <button onclick="format('hiliteColor','yellow')">高亮</button>
          </div>

          <div class="editor" id="editor" contenteditable="true"></div>
          <div id="postMsg" class="error"></div>
          <button onclick="createPost()">发表帖子</button>

          <h3 style="margin-top:20px;">帖子列表</h3>
          <div id="postList"></div>
          <div id="liveWarning" class="bad-warning" style="display:none;">检测到违规内容，已记录并将触发快速响应。</div>
        </div>
      `;
            renderList();
        }

        /* 编辑器命令 */
        function format(cmd, val = null) {
            document.execCommand(cmd, false, val);
        }

        /* 发帖逻辑 - 强制标题 + 内容，检测违规，触发快速NPC回击（10 条 1 秒间隔） */
        function createPost() {
            const title = document.getElementById("postTitle").value.trim();
            const content = document.getElementById("editor").innerHTML.trim();
            const postMsg = document.getElementById("postMsg");
            postMsg.innerText = "";
            document.getElementById("liveWarning").style.display = "none";

            if (!title || !content || content === "<br>") {
                postMsg.innerText = "标题和内容均为必填项。";
                return;
            }

            // 检测脏词或非中文为主
            const full = title + " " + stripTagsHtml(content);
            let flaggedBadWords = containsBad(full);
            let flaggedNonChinese = isMostlyNonChinese(full);

            // 创建帖子（不自动阻止发帖，但会记录违规并触发反应）
            const post = {
                id: Date.now(),
                author: account.username,
                title,
                content,
                replies: []
            };
            forum.unshift(post);
            saveAll();
            renderList();
            document.getElementById("postTitle").value = "";
            document.getElementById("editor").innerHTML = "";

            // 如果违规 -> 标记、快速 NPC 集体回复（10 条 1 秒间隔）
            if (flaggedBadWords || flaggedNonChinese) {
                violations++;
                saveAll();
                document.getElementById("liveWarning").style.display = "block";
                triggerFastNPCReplies(post.id, 10, 1000); // 10 条，每 1 秒
            }

            // 如果累计达到阈值 -> 立即封禁并显示无样式封禁页
            if (violations >= 2) {
                banned = true;
                saveAll();
                showBan();
                return;
            }
        }

        /* 快速 NPC 回应：数量 n，间隔 ms（逐条加入帖子 replies）
           回复内容为“非侮辱性但强烈的制裁/警告短句” */
        function triggerFastNPCReplies(postId, n, ms) {
            const post = forum.find(p => p.id === postId);
            if (!post) return;
            let count = 0;
            const phrases = [
                "该言论已被记录并将被上报。",
                "请立即停止不当言论，遵守社区规范。",
                "此类内容会导致封禁，请自重。",
                "我们已经截图并向管理员报告。",
                "请使用中文发言，尊重社区规则。",
                "警告：再次违规将被封禁处理。",
                "请保持理性，否则将被永久封禁。",
                "系统提醒：严禁发布违法或攻击性内容。",
                "社区守则要求文明讨论，请配合。",
                "您已触犯社区规则，建议立即整改。"
            ];
            const intervalId = setInterval(() => {
                if (banned || count >= n || post.replies.length >= 50) {
                    clearInterval(intervalId);
                    return;
                }
                const phrase = phrases[count % phrases.length];
                post.replies.push({ author: npcNames[count % npcNames.length], content: phrase });
                saveAll();
                // 如果当前正在查看该帖，刷新详情界面
                if (document.getElementById("repliesArea") && currentViewingPostId === postId) {
                    renderReplies(post);
                } else {
                    // 否则刷新列表（显示回复计数）
                    renderList();
                }
                count++;
            }, ms);
        }

        /* 渲染标题列表 */
        let currentViewingPostId = null;
        function renderList() {
            const list = document.getElementById("postList");
            if (!list) return;
            list.innerHTML = "";
            forum.forEach(p => {
                const div = document.createElement("div");
                div.className = "postItem";
                div.innerHTML = `<div class="postTitle">${escapeHtml(p.title)}</div><div class="postMeta">作者：${escapeHtml(p.author)} &nbsp; • &nbsp; 回复：${p.replies.length}</div>`;
                div.onclick = () => showPost(p.id);
                list.appendChild(div);
            });
        }

        /* 帖子详情 */
        function showPost(id) {
            currentViewingPostId = id;
            const p = forum.find(x => x.id === id);
            if (!p) return showForum();

            document.getElementById("app").innerHTML = `
        <div class="header">${escapeHtml(p.title)}</div>
        <div class="container">
          <div class="smallNote">作者：${escapeHtml(p.author)}</div>
          <div style="margin-top:10px;padding:10px;border:1px solid #eee;border-radius:6px;background:#fff">${p.content}</div>

          <h3 style="margin-top:16px;">回复</h3>
          <div id="repliesArea"></div>

          <div style="margin-top:12px;">回复工具栏：
            <button onclick="formatReply('bold')"><b>B</b></button>
            <button onclick="formatReply('italic')"><i>I</i></button>
            <button onclick="formatReply('hiliteColor','yellow')">高亮</button>
          </div>

          <div id="replyEditor" class="editor" contenteditable="true"></div>
          <div id="replyMsg" class="error"></div>
          <button onclick="submitReply(${p.id})">提交回复</button>
          <button onclick="showForum()" style="margin-left:10px;">返回列表</button>
        </div>
      `;
            renderReplies(p);
        }

        /* 渲染回复（允许富文本展示） */
        function renderReplies(post) {
            const area = document.getElementById("repliesArea");
            area.innerHTML = "";
            post.replies.forEach((r, idx) => {
                const div = document.createElement("div");
                div.className = "reply";
                div.innerHTML = `<b>${escapeHtml(r.author)}</b>：<div style="margin-top:6px;">${r.content}</div>
          <div style="margin-top:6px;"><button onclick="quoteReply(${post.id}, ${idx})">引用</button></div>`;
                area.appendChild(div);
            });
        }

        /* 回复编辑器命令（针对 replyEditor） */
        function formatReply(cmd, val = null) {
            const editor = document.getElementById("replyEditor");
            editor.focus();
            document.execCommand(cmd, false, val);
        }

        /* 引用回复到回复编辑器 */
        function quoteReply(postId, replyIdx) {
            const post = forum.find(x => x.id === postId);
            if (!post) return;
            const r = post.replies[replyIdx];
            const editor = document.getElementById("replyEditor");
            const quoteHtml = `<div class="quote">引用 ${escapeHtml(r.author)}：<div>${escapeHtml(stripTagsHtml(r.content))}</div></div><br>`;
            editor.innerHTML += quoteHtml;
        }

        /* 提交回复（检测违规并触发快速 NPC 响应） */
        function submitReply(postId) {
            const editor = document.getElementById("replyEditor");
            const content = editor.innerHTML.trim();
            const msgEl = document.getElementById("replyMsg");
            msgEl.innerText = "";
            if (!content || content === "<br>") {
                msgEl.innerText = "回复内容不能为空。";
                return;
            }

            const post = forum.find(x => x.id === postId);
            const full = stripTagsHtml(content);
            let flaggedBadWords = containsBad(full);
            let flaggedNonChinese = isMostlyNonChinese(full);

            // 将回复加入
            post.replies.push({ author: account.username, content });
            saveAll();

            if (flaggedBadWords || flaggedNonChinese) {
                violations++;
                saveAll();
                // 触发 10 条 1 秒间隔快速 NPC 回复
                triggerFastNPCReplies(postId, 10, 1000);
            }

            if (violations >= 2) {
                banned = true;
                saveAll();
                showBan();
                return;
            }

            showPost(postId);
        }

        /* 工具：转义、去标签 */
        function escapeHtml(str) {
            if (!str) return "";
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }
        function stripTagsHtml(html) {
            return (html || "").replace(/<[^>]*>/g, '');
        }

        /* ---------- NPC 定期行为 ---------- */
        /* 每 6 秒为帖子补充普通 NPC 回复（最多 5 条） */
        setInterval(() => {
            if (!account || banned) return;
            let changed = false;
            forum.forEach(p => {
                if (p.replies.length < 5) {
                    p.replies.push({
                        author: npcNames[Math.floor(Math.random() * npcNames.length)],
                        content: npcReplies[Math.floor(Math.random() * npcReplies.length)]
                    });
                    changed = true;
                }
            });
            if (changed) { saveAll(); if (document.getElementById("postList")) renderList(); }
        }, 6000);

        /* 每 1~5 分钟随机生成 NPC 帖子 */
        function scheduleNPCPost() {
            if (account && !banned) {
                forum.unshift({
                    id: Date.now(),
                    author: npcNames[Math.floor(Math.random() * npcNames.length)],
                    title: npcTitles[Math.floor(Math.random() * npcTitles.length)],
                    content: "（系统自动生成）欢迎参与讨论。",
                    replies: []
                });
                saveAll();
                if (document.getElementById("postList")) renderList();
            }
            const next = Math.floor(Math.random() * 240000) + 60000; // 1~5 分钟
            setTimeout(scheduleNPCPost, next);
        }

        /* ---------- 封禁页（无样式纯 HTML） ---------- */
        function showBan() {
            // 生成封禁编号与时间
            const banId = "HX-" + Math.floor(Math.random() * 900000 + 100000);
            const now = new Date();
            const timeStr = now.getFullYear() + "年" + (now.getMonth() + 1) + "月" + now.getDate() + "日 " + now.toLocaleTimeString();

            // 清空 head（移除样式）并替换 body 为纯 HTML 内容
            document.head.innerHTML = '<meta charset="utf-8"><title>IP 已封禁</title><meta name="google" content="notranslate">';
            document.body.innerHTML = `
        <h1>IP 已封禁</h1>
        <p>尊敬的用户，您的访问已被限制。</p>

        <p><strong>封禁编号：</strong> ${banId}</p>
        <p><strong>被封禁的 IP：</strong> ${fakeIP}</p>
        <p><strong>处理时间：</strong> ${timeStr}</p>

        <p><strong>违规原因：</strong> 多次发布违反社区规范的言论（包含不当用语或大量非中文发言）</p>

        <p><strong>执行机构：</strong> 华夏社区管理中心（模拟）</p>
        <p><strong>责任管理员：</strong> 张网管（模拟）</p>
        <p><strong>联系方式：</strong> service@huaxia-security.cn / 电话：010-8888-8888（模拟）</p>

        <h2>申诉</h2>
        <p>如果您认为本次封禁有误，可填写下方申诉表（此表为本地模拟，不会发送任何真实请求）：</p>

        <form id="appealForm">
          <div>用户名：<br><input name="username" /></div>
          <div>联系方式（电话或邮箱）：<br><input name="contact" /></div>
          <div>身份证号码（可选）：<br><input name="idnumber" /></div>
          <div>申诉理由：<br><textarea name="reason"></textarea></div>
          <div><button type="submit">提交申诉</button></div>
        </form>

        <div id="appealResult" style="margin-top:12px;"></div>
      `;

            // 绑定表单事件（DOM 中存在元素后绑定）
            const form = document.getElementById('appealForm');
            if (form) {
                form.addEventListener('submit', function (ev) {
                    ev.preventDefault();
                    try {
                        const data = {
                            username: this.username.value || '',
                            contact: this.contact.value || '',
                            idnumber: this.idnumber.value || '',
                            reason: this.reason.value || '',
                            time: new Date().toString()
                        };
                        const existing = JSON.parse(localStorage.getItem('huaxia_appeals') || '[]');
                        existing.push(data);
                        localStorage.setItem('huaxia_appeals', JSON.stringify(existing));
                        document.getElementById('appealResult').innerText = '您的申诉已记录，等待审核（模拟）。';
                        this.querySelectorAll('input,textarea,button').forEach(el => el.disabled = true);
                    } catch (e) {
                        document.getElementById('appealResult').innerText = '申诉提交失败（本地模拟）。';
                    }
                });
            }
        }

        /* ---------- 启动流程 ---------- */
        if (banned) {
            showBan();
        } else if (!account) {
            showRegister();
        } else {
            showForum();
            scheduleNPCPost();
        }
        saveAll();

    </script>
</body>
</html>
