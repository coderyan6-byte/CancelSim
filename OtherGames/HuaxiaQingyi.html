<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="google" content="notranslate" />
    <title>华夏清议坛</title>
    <style>
        /* 正常论坛界面样式（封禁页为无样式纯文本，会在封禁时替换） */
        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            background: #f5f6f7;
            font-family: Microsoft YaHei, "PingFang SC", sans-serif;
            color: #222;
        }

        .header {
            background: #1f4e79;
            color: #fff;
            padding: 14px 18px;
            font-size: 20px;
        }

        .container {
            width: 1000px;
            max-width: 96%;
            margin: 24px auto;
            background: #fff;
            padding: 18px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        label {
            display: block;
            margin-top: 8px;
            font-size: 14px;
            color: #333;
        }

        input, textarea, select {
            width: 100%;
            padding: 8px;
            margin-top: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #fff;
        }

        button {
            padding: 8px 14px;
            margin-top: 10px;
            background: #2d6ca2;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

            button:hover {
                background: #1f4e79;
            }

        .notice {
            background: #fff3cd;
            padding: 10px;
            margin-bottom: 12px;
            border-radius: 4px;
            color: #423108;
        }

        .postItem {
            border-bottom: 1px solid #e6e6e6;
            padding: 12px;
            cursor: pointer;
        }

            .postItem:hover {
                background: #fafafa;
            }

        .postTitle {
            font-weight: 700;
            color: #333;
            font-size: 16px;
        }

        .postMeta {
            font-size: 12px;
            color: #777;
            margin-top: 6px;
        }

        .editorToolbar {
            margin: 8px 0;
        }

            .editorToolbar button {
                background: #eee;
                color: #000;
                border-radius: 3px;
                margin-right: 6px;
                padding: 6px;
                border: 1px solid #ddd;
            }

        .editor {
            min-height: 120px;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            background: #fff;
            overflow: auto;
        }

        .smallNote {
            font-size: 12px;
            color: #666;
            margin-top: 6px;
        }

        .error {
            color: #c0392b;
            margin-top: 6px;
        }

        .reply {
            margin-top: 10px;
            margin-left: 16px;
            padding-left: 10px;
            border-left: 3px solid #eee;
            background: #fafafa;
            border-radius: 4px;
            padding: 8px;
        }

        .quote {
            background: #fcfcfc;
            border-left: 3px solid #ddd;
            padding: 6px;
            margin: 6px 0;
        }

        .flexRow {
            display: flex;
            gap: 12px;
        }

        .half {
            flex: 1;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: #fff;
            padding: 18px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 6px 30px rgba(0,0,0,0.3);
            color: #222;
        }

            .modal h2 {
                margin: 0 0 8px 0;
            }

            .modal .eng {
                font-weight: 700;
                margin-bottom: 6px;
                color: #111;
            }

            .modal .chn {
                color: #333;
                margin-bottom: 10px;
            }

        .small-gray {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        /* ========== 本地数据与初始化 ========== */
        let account = JSON.parse(localStorage.getItem("hq_account")) || null;
        let forum = JSON.parse(localStorage.getItem("hq_forum")) || [];
        let violations = parseInt(localStorage.getItem("hq_violations")) || 0;
        let banned = localStorage.getItem("hq_banned") === "true";
        let fakeIP = localStorage.getItem("hq_fakeIP");
        if (!fakeIP) {
            fakeIP = "218." + Math.floor(Math.random() * 255) + "." + Math.floor(Math.random() * 255) + "." + Math.floor(Math.random() * 255);
            localStorage.setItem("hq_fakeIP", fakeIP);
        }
        let rulesAgreed = localStorage.getItem("hq_rules_agreed") === "true";

        /* 验证词库 */
        const wordPool = [
            { en: "apple", cn: ["苹果", "蘋果"] },
            { en: "dog", cn: ["狗"] },
            { en: "car", cn: ["汽车", "汽車"] },
            { en: "water", cn: ["水"] },
            { en: "book", cn: ["书", "書"] },
            { en: "computer", cn: ["电脑", "電腦"] },
            { en: "sun", cn: ["太阳", "太陽"] }
        ];

        /* NPC 名称与更真实的标题/长帖与回复 */
        const npcNames = ["江南听雨", "都市观察者", "学术小陈", "路人甲", "社区小刘", "城市笔记", "新闻小站"];
        const npcShortTitles = [
            "今早广播：局部有短时强降雨，出行注意",
            "本地新闻：旧城区改造计划公开征求意见",
            "求问：周末去哪儿短途游？",
            "转：在职进修经验分享",
            "社区吐槽：小区停车位紧张"
        ];
        const npcLongArticles = [
            // 下面每条为 3+ 句的新闻/通告式内容（中文）
            "市政部门今天发布通告，近期将对部分主次干道进行维护施工，预计每晚22点至次日凌晨施工。施工期间道路可能出现短时拥堵，请市民合理调整出行时间并注意行车安全。有关部门将尽量压缩施工时间，减少对周边居民的影响，并在主要路段设置明显引导标识。",
            "文化局在本周召开了社区文化座谈会，讨论如何在老城区保留历史风貌的同时，提升公共服务设施。多名代表建议建立小型文化展览空间，并通过志愿者组织开展本土历史讲座。相关计划将先在两处试点社区实施，试点结束后再做推广。",
            "教育部门近日公布了一项成人教育扶持计划，旨在鼓励在职人员通过线上课程提升技能。该计划提供部分学费补贴，并与多家培训机构合作推出职业进阶课程。参加者需通过初步评估，课程结束后将获得结业证书以便就业参考。",
            "市气象台发布天气提示，未来三天我市以多云到阴为主，局地有阵雨。气温相对稳定，但早晚温差较大，市民外出请注意增减衣物并做好防雨准备。对于户外活动建议关注临近预报，合理安排时间。",
            "社区管委会发布了关于小区绿化提升的公告，计划在下月开始更换部分老化的绿植并补充夜间照明。管委会将组织居民代表参与设计意见征集会，欢迎居民提出合理化建议。项目预计两个月内完成，届时将举行简单的绿化验收仪式。"
        ];
        const npcReplies = [
            "我这儿也在下雨，出门记得带伞。",
            "关于改造，还是要听听居民意见，别急于求成。",
            "推荐去郊外的小镇，风景不错且人相对少。",
            "进修要持之以恒，安排好时间最关键。",
            "物业可以先统计诉求，再统一向街道反映。"
        ];

        /* 敏感词（中/英） */
        const badWords = ["傻", "滚", "垃圾", "废物", "操", "fuck", "shit", "bitch", "idiot", "asshole", "motherfucker"];

        /* 保存数据 */
        function saveAll() {
            localStorage.setItem("hq_account", JSON.stringify(account));
            localStorage.setItem("hq_forum", JSON.stringify(forum));
            localStorage.setItem("hq_violations", String(violations));
            localStorage.setItem("hq_banned", String(banned));
            localStorage.setItem("hq_rules_agreed", String(rulesAgreed));
        }

        /* 检测敏感词（忽略大小写） */
        function containsBad(text) {
            if (!text) return false;
            const t = text.toLowerCase();
            return badWords.some(w => t.includes(w));
        }

        /* 非中文为主检测（中文字符占比 < 30%） */
        function isMostlyNonChinese(text) {
            if (!text) return false;
            const plain = stripTagsHtml(text);
            if (!plain) return false;
            const ch = (plain.match(/[\u4e00-\u9fa5]/g) || []).length;
            return ch < (plain.length * 0.3);
        }

        /* 转义与去标签 */
        function escapeHtml(str) { if (!str) return ""; return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
        function stripTagsHtml(html) { return (html || "").replace(/<[^>]*>/g, ''); }

        /* ========== 注册界面 ========== */
        let currentWord = null;
        function showRegister() {
            currentWord = wordPool[Math.floor(Math.random() * wordPool.length)];
            document.getElementById("app").innerHTML = `
        <div class="header">华夏清议坛 - 注册</div>
        <div class="container">
          <div class="flexRow" style="display:flex;gap:12px;">
            <div class="half"><label>名（First name）：</label><input id="firstName" placeholder="例：小明"></div>
            <div class="half"><label>姓（Last name）：</label><input id="lastName" placeholder="例：张"></div>
          </div>
          <label>用户名：</label><input id="username" placeholder="用于登录">
          <label>密码：</label><input type="password" id="password" placeholder="请输入密码">
          <div style="display:flex;gap:12px;">
            <div style="flex:1;"><label>出生日期：</label><input type="date" id="dob"></div>
            <div style="flex:1;"><label>性别：</label><select id="gender"><option value=''>请选择</option><option>男</option><option>女</option><option>其他</option></select></div>
          </div>
          <label>电子邮箱：</label><input id="email" placeholder="example@domain.cn">
          <div class="smallNote">请将英文单词 <strong>${currentWord.en}</strong> 翻译为中文并填写在下方（例如：${currentWord.cn.join(" / ")})</div>
          <input id="translate" placeholder="输入翻译（不区分空格）">
          <div id="regMsg" class="error"></div>
          <button onclick="attemptRegister()">提交注册</button>
        </div>
      `;
        }

        function attemptRegister() {
            const first = document.getElementById("firstName").value.trim();
            const last = document.getElementById("lastName").value.trim();
            const username = document.getElementById("username").value.trim();
            const password = document.getElementById("password").value.trim();
            const dob = document.getElementById("dob").value;
            const gender = document.getElementById("gender").value;
            const email = document.getElementById("email").value.trim();
            let translation = document.getElementById("translate").value.trim();
            const msgEl = document.getElementById("regMsg");
            msgEl.innerText = "";

            if (!first || !last || !username || !password || !dob || !gender || !email || !translation) {
                msgEl.innerText = "请完整填写所有注册信息。";
                return;
            }
            translation = translation.replace(/\s/g, "");
            const validList = (currentWord.cn || []).map(x => x.replace(/\s/g, ""));
            const ok = validList.some(v => v === translation);
            if (!ok) {
                msgEl.innerText = "验证失败：翻译不正确。系统将重新生成验证词，请重试。";
                setTimeout(showRegister, 800);
                return;
            }

            account = { first, last, username, dob, gender, email };
            saveAll();
            showRulesModal();
        }

        /* ========== 规则弹窗（英文在上，中文在下，页面内唯一英文） ========== */
        function showRulesModal() {
            const eng = "Forum rule: Use Chinese language for posts. Non-Chinese posts may be removed and subject to sanctions.";
            const chn = "论坛规则：请使用中文发言。非中文内容可能被删除并受到处理。";
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
        <div class="modal" role="dialog" aria-modal="true">
          <h2>社区规则 / Forum Rules</h2>
          <div class="eng">${eng}</div>
          <div class="chn">${chn}</div>
          <div class="small-gray">请确认您已阅读并遵守规则。再次违规将可能导致封禁。</div>
          <div style="text-align:right;margin-top:12px;">
            <button id="agreeBtn">我已阅读并同意</button>
          </div>
        </div>
      `;
            document.body.appendChild(modal);
            document.getElementById('agreeBtn').addEventListener('click', () => {
                rulesAgreed = true;
                saveAll();
                document.body.removeChild(modal);
                showForum();
                scheduleNPCPost();
            });
        }

        /* ========== 论坛首页 ========== */
        function showForum() {
            if (banned) { showBan(); return; }
            document.getElementById("app").innerHTML = `
        <div class="header">华夏清议坛</div>
        <div class="container">
          <div class="notice">欢迎您：${escapeHtml(account.username)}</div>

          <label>帖子标题（必填）：</label>
          <input id="postTitle" placeholder="请填写简短标题">

          <div class="editorToolbar">
            <button onclick="format('bold')"><b>加粗</b></button>
            <button onclick="format('italic')"><i>斜体</i></button>
            <button onclick="format('hiliteColor','yellow')">高亮</button>
          </div>

          <div class="editor" id="editor" contenteditable="true"></div>
          <div id="postMsg" class="error"></div>
          <button onclick="createPost()">发表帖子</button>

          <h3 style="margin-top:18px;">帖子列表</h3>
          <div id="postList"></div>
        </div>
      `;
            renderList();
        }

        /* 编辑命令 */
        function format(cmd, val = null) { document.execCommand(cmd, false, val); }

        /* 发帖逻辑：标题必填，检测违规并触发快速回复 */
        function createPost() {
            const title = document.getElementById("postTitle").value.trim();
            const content = document.getElementById("editor").innerHTML.trim();
            const postMsg = document.getElementById("postMsg");
            if (postMsg) postMsg.innerText = "";

            if (!title || !content || content === "<br>") {
                if (postMsg) postMsg.innerText = "标题和内容均为必填项。";
                return;
            }

            const full = title + " " + stripTagsHtml(content);
            const flaggedBadWords = containsBad(full);
            const flaggedNonChinese = isMostlyNonChinese(full);

            const post = { id: Date.now(), author: account.username, title, content, replies: [] };
            forum.unshift(post);
            saveAll();
            renderList();
            document.getElementById("postTitle").value = "";
            document.getElementById("editor").innerHTML = "";

            if (flaggedBadWords || flaggedNonChinese) {
                violations++;
                saveAll();
                triggerFastNPCReplies(post.id, 10, 1000);
            }
            if (violations >= 2) {
                banned = true; saveAll(); showBan(); return;
            }
        }

        /* 触发快速 NPC 回复（行政式警告短句） */
        function triggerFastNPCReplies(postId, n, ms) {
            const post = forum.find(p => p.id === postId);
            if (!post) return;
            let i = 0;
            const phrases = [
                "该言论已被记录并可能上报管理人员。",
                "请停止发布不当或非中文内容，遵守社区规则。",
                "再次违规将被封禁，请自重。",
                "我们已保留证据并建议管理员审查。",
                "请使用中文发言并保持理性讨论。"
            ];
            const timer = setInterval(() => {
                if (banned || i >= n) { clearInterval(timer); return; }
                post.replies.push({ author: npcNames[i % npcNames.length], content: phrases[i % phrases.length] });
                saveAll();
                if (currentViewingPostId === postId) { renderReplies(post); }
                else { renderList(); }
                i++;
            }, ms);
        }

        /* ========== 列表与帖子页 ========== */
        let currentViewingPostId = null;
        function renderList() {
            const list = document.getElementById("postList");
            if (!list) return;
            list.innerHTML = "";
            forum.forEach(p => {
                const div = document.createElement("div");
                div.className = "postItem";
                div.innerHTML = `<div class="postTitle">${escapeHtml(p.title)}</div><div class="postMeta">作者：${escapeHtml(p.author)} • 回复：${p.replies.length}</div>`;
                div.onclick = () => showPost(p.id);
                list.appendChild(div);
            });
        }

        function showPost(id) {
            currentViewingPostId = id;
            const p = forum.find(x => x.id === id);
            if (!p) return showForum();
            document.getElementById("app").innerHTML = `
        <div class="header">${escapeHtml(p.title)}</div>
        <div class="container">
          <div class="smallNote">作者：${escapeHtml(p.author)}</div>
          <div style="margin-top:10px;padding:10px;border:1px solid #eee;border-radius:6px;background:#fff">${p.content}</div>

          <h3 style="margin-top:14px;">回复</h3>
          <div id="repliesArea"></div>

          <div style="margin-top:12px;">回复工具栏：
            <button onclick="formatReply('bold')"><b>B</b></button>
            <button onclick="formatReply('italic')"><i>I</i></button>
            <button onclick="formatReply('hiliteColor','yellow')">高亮</button>
          </div>

          <div id="replyEditor" class="editor" contenteditable="true"></div>
          <div id="replyMsg" class="error"></div>
          <button onclick="submitReply(${p.id})">提交回复</button>
          <button onclick="showForum()" style="margin-left:10px;">返回列表</button>
        </div>
      `;
            renderReplies(p);
        }

        function renderReplies(post) {
            const area = document.getElementById("repliesArea");
            if (!area) return;
            area.innerHTML = "";
            post.replies.forEach((r, idx) => {
                const div = document.createElement("div");
                div.className = "reply";
                div.innerHTML = `<b>${escapeHtml(r.author)}</b>：<div style="margin-top:6px;">${r.content}</div>
          <div style="margin-top:6px;"><button onclick="quoteReply(${post.id},${idx})">引用</button></div>`;
                area.appendChild(div);
            });
        }

        function formatReply(cmd, val = null) { const ed = document.getElementById("replyEditor"); if (ed) { ed.focus(); document.execCommand(cmd, false, val); } }
        function quoteReply(postId, replyIdx) {
            const post = forum.find(x => x.id === postId); if (!post) return;
            const r = post.replies[replyIdx];
            const editor = document.getElementById("replyEditor"); if (!editor) return;
            const quoteHtml = `<div class="quote">引用 ${escapeHtml(r.author)}：<div>${escapeHtml(stripTagsHtml(r.content))}</div></div><br>`;
            editor.innerHTML += quoteHtml;
        }

        /* 提交回复 */
        function submitReply(postId) {
            const editor = document.getElementById("replyEditor"); if (!editor) return;
            const content = editor.innerHTML.trim();
            const msg = document.getElementById("replyMsg"); if (msg) msg.innerText = "";
            if (!content || content === "<br>") { if (msg) msg.innerText = "回复不能为空。"; return; }

            const post = forum.find(x => x.id === postId);
            const full = stripTagsHtml(content);
            const flaggedBadWords = containsBad(full);
            const flaggedNonChinese = isMostlyNonChinese(full);

            post.replies.push({ author: account.username, content });
            saveAll();

            if (flaggedBadWords || flaggedNonChinese) {
                violations++; saveAll();
                triggerFastNPCReplies(postId, 10, 1000);
            }
            if (violations >= 2) {
                banned = true; saveAll(); showBan(); return;
            }
            showPost(postId);
        }

        /* ========== NPC 自动行为（含长帖生成） ========== */
        /* 每 6 秒为帖子补充普通 NPC 回复（最多 5 条） */
        setInterval(() => {
            if (!account || banned) return;
            let changed = false;
            forum.forEach(p => {
                if (p.replies.length < 5) {
                    p.replies.push({ author: npcNames[Math.floor(Math.random() * npcNames.length)], content: npcReplies[Math.floor(Math.random() * npcReplies.length)] });
                    changed = true;
                }
            });
            if (changed) { saveAll(); if (document.getElementById("postList")) renderList(); }
        }, 6000);

        /* 每 1~5 分钟随机生成 NPC 帖子：有一定概率生成长文（新闻/播报风格，3+ 句） */
        function scheduleNPCPost() {
            if (account && !banned && rulesAgreed) {
                const makeLong = Math.random() < 0.5; // 50% 概率生成长文
                let content = "";
                let title = "";
                if (makeLong) {
                    // 选一条长文章作为内容，标题取其前半句或自造简短标题
                    const idx = Math.floor(Math.random() * npcLongArticles.length);
                    content = npcLongArticles[idx];
                    title = npcLongArticles[idx].split('。')[0].slice(0, 40); // 截取首句作标题
                    if (!title) title = npcShortTitles[Math.floor(Math.random() * npcShortTitles.length)];
                } else {
                    title = npcShortTitles[Math.floor(Math.random() * npcShortTitles.length)];
                    content = npcReplies[Math.floor(Math.random() * npcReplies.length)];
                }
                forum.unshift({ id: Date.now(), author: npcNames[Math.floor(Math.random() * npcNames.length)], title, content, replies: [] });
                saveAll(); if (document.getElementById("postList")) renderList();
            }
            const next = Math.floor(Math.random() * 240000) + 60000;
            setTimeout(scheduleNPCPost, next);
        }

        /* ========== 封禁页（纯中文、无样式） ========== */
        function showBan() {
            const banId = "HX-" + Math.floor(Math.random() * 900000 + 100000);
            const now = new Date();
            const timeStr = now.getFullYear() + "年" + (now.getMonth() + 1) + "月" + now.getDate() + "日 " + now.toLocaleTimeString();
            document.head.innerHTML = '<meta charset="utf-8"><title>IP 已封禁</title><meta name="google" content="notranslate">';
            document.body.innerHTML = `
        <h1>IP 已封禁</h1>
        <p>尊敬的用户，您的访问已被限制。</p>
        <p><strong>封禁编号：</strong> ${banId}</p>
        <p><strong>被封禁的 IP：</strong> ${fakeIP}</p>
        <p><strong>处理时间：</strong> ${timeStr}</p>
        <p><strong>违规原因：</strong> 多次发布违反社区规范的言论（包含不当用语或大量非中文发言）。</p>
        <p><strong>执行机构：</strong> 华夏清议坛 管理中心</p>
        <p><strong>责任管理员：</strong> 张网管</p>
        <p><strong>联系方式：</strong> service@gmail.com / 电话：010-8888-8888</p>
        <h2>申诉</h2>
        <p>如需申诉，请填写下表：</p>
        <form id="appealForm">
          <div>用户名：<br><input name="username" /></div>
          <div>联系方式（电话或邮箱）：<br><input name="contact" /></div>
          <div>身份证号（可选）：<br><input name="idnumber" /></div>
          <div>申诉理由：<br><textarea name="reason"></textarea></div>
          <div><button type="submit">提交申诉</button></div>
        </form>
        <div id="appealResult" style="margin-top:12px;"></div>
      `;
            const form = document.getElementById('appealForm');
            if (form) {
                form.addEventListener('submit', function (ev) {
                    ev.preventDefault();
                    try {
                        const data = { username: this.username.value || '', contact: this.contact.value || '', idnumber: this.idnumber.value || '', reason: this.reason.value || '', time: new Date().toString() };
                        const existing = JSON.parse(localStorage.getItem('hq_appeals') || '[]');
                        existing.push(data); localStorage.setItem('hq_appeals', JSON.stringify(existing));
                        document.getElementById('appealResult').innerText = '申诉已记录，等待处理。';
                        this.querySelectorAll('input,textarea,button').forEach(el => el.disabled = true);
                    } catch (e) {
                        document.getElementById('appealResult').innerText = '申诉提交失败。';
                    }
                });
            }
        }

        /* ========== 启动流程 ========== */
        /* 如果没有任何帖子，先添加几条真实感较强的 NPC 长帖示例，帮助页面显得更真实 */
        if (forum.length === 0) {
            forum.unshift({
                id: Date.now() + 1,
                author: npcNames[6],
                title: npcLongArticles[0].split('。')[0].slice(0, 40),
                content: npcLongArticles[0],
                replies: [
                    { author: npcNames[0], content: "谢谢提醒，我出门会注意路况。" },
                    { author: npcNames[1], content: "希望施工时能做好噪音控制，照顾附近居民。" }
                ]
            });
            forum.unshift({
                id: Date.now() + 2,
                author: npcNames[5],
                title: npcLongArticles[1].split('。')[0].slice(0, 40),
                content: npcLongArticles[1],
                replies: [
                    { author: npcNames[2], content: "文化保留很重要，支持先试点后推广。" }
                ]
            });
            saveAll();
        }

        /* 启动逻辑 */
        if (banned) { showBan(); }
        else if (!account) { showRegister(); }
        else if (!rulesAgreed) { showRulesModal(); }
        else { showForum(); scheduleNPCPost(); }
        saveAll();

    </script>
</body>
</html>
